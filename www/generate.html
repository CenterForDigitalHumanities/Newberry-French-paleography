<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Generate Markdown From CSV | French Paleography</title>
    <link rel="stylesheet" href="./css/style.css">
</head>

<body>
    <header></header>
    <div> 
        <p>Click below to generate a new "Background Essays" markdown folder.  The current folder will be backed up.</p>
        <input type="button" value="Generate New Background Essays Markdown from the CSV" onclick=""/>
    </div>
    <div> 
        <p>Click below to generate a new "Partial Transcriptions" markdown folder.  The current folder will be backed up.</p>
        <input type="button" value="Generate New Partial Transcription Markdown from the CSV" onclick="newPartialTranscriptions(event)"/>
    </div>
    <footer></footer>
    <script src="./script/utils.js"></script>
    <script src="./csv-parser/papaparse.min.js"></script>
</body>

<script type="text/javascript">
    window.requestFileSystem  = window.requestFileSystem ? window.requestFileSystem : window.webkitRequestFileSystem
    async function alterFileStructure(parsedCSV){
        console.warn("Attempting file structure magic. Below is your parsed CSV data.")
        console.log(parsedCSV)
        let transcriptions_now = "_transcriptions_"+new Date().getTime()
        /*Backup Current Folder Using Timestamp*/
        /*Remove current folder*/
        /*Generate new folder to save into*/
        window.requestFileSystem(window.TEMPORARY, 1024*1024, async function(fs) {
            createDir(fs.root, [transcriptions_now])
            .then(() => {
                /*Go over each "row" and generate the appropriate .md file for it.  Save that md file with strategic name.*/
                console.log("Generate a file for each row")
                parsedCSV.data.forEach(row => {
                    let l = row["Manuscript Link"].trim()
                    const utl_id = l.substr(l.lastIndexOf("paleography:"), l.length-1).replace("paleography:", "")
                    //const utl_id = l.substr(0, l.lastIndexOf("_")).replace("ip_","").replace("fp_","");
                    let links = `
                         
                        <table border="0.5" cellpadding="1" cellspacing="1" style="width: 200px; background-color:#F8F8F8;">
                            <tbody style="border-color:#ccc">
                                <tr style="border-color:#ccc">
                                    <td>Go to <a href="https://centerfordigitalhumanities.github.io/Newberry-French-paleography/essay/${utl_id}" target="_blank">Background Essay</a></td>
                                    <td>Go to <a href="https://centerfordigitalhumanities.github.io/Newberry-French-paleography/www/record.html?id=${utl_id}" target="_blank">Manuscript</a> page</td>
                                </tr>
                            </tbody>
                        </table>
                         
                    `
                    let mdHeader = `
                        ---
                        layout: default
                        title: ${row["Title"]}
                        utl_id: utl_id
                        ---
                    `
                    let mdBody = `
                        ${row["Title"]}  
                        ${row["Manuscript Title"]}  
                        ${row["Description"]}  
                        ${links}
                        ${row["Partial Transcription"]}
                    `
                    let fileText = mdHeader + mdBody
                    console.log("Here is the file text")
                    console.log(fileText)
                    /*Save file as ${regex(row["Manuscript Link"]}.md into new _transcriptions or _background_essay folder*/
                    createFile(fs.root, transcriptions_now, utl_id+".md", fileText)
                })    
            })
            .catch(err => {
                console.log("Error 2")
                errorHandler(err)
            })
            .finally(info => {console.log("Finished with file structure work and creating the files")})
        }, errorHandler)
    }

    async function newBackgroundEssays(event){
        var r = confirm("Are you sure you want to make new files?  The old files will be backed up but will no longer be used.");
        if (r == true) {
            let txt = await fetch("./csv-parser/csv/background-essay.csv", {
                method: "GET",
                mode: "cors",
                headers: {
                    'Content-Type': 'text/csv;charset=utf-8'
                }
            })
            .then(response => response.text())
            .catch(err => {return new Error("Could not get CSV file")})
            let parsedCSV = await getFromCSVInfo(txt)
            alterFileStructure(parsedCSV)
            return parsedCSV
            
        }
    }

    async function newPartialTranscriptions(event){
        var r = confirm("Are you sure you want to make new files?  The old files will be backed up but will no longer be used.");
        if (r == true) {
            let txt = await fetch("./csv-parser/csv/partial-transcriptions.csv", {
                method: "GET",
                mode: "cors",
                headers: {
                    'Content-Type': 'text/csv;charset=utf-8'
                }
            })
            .then(response => response.text())
            .catch(err => {return new Error("Could not get CSV file")})
            let parsedCSV = await getFromCSVInfo(txt)
            alterFileStructure(parsedCSV)
        }
    }

    async function getFromCSVInfo(fileText){

        return Papa.parse(fileText, {
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                return results
            }
        })

        /*
        return new Promise(resolve => {
            Papa.parse(fileText, {
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    resolve(results.data)
                }
            })
        })
        */
    }

    async function renameDir(rootDirEntry, src, newName) {
        return new Promise(resolve => {
            rootDirEntry.getDirectory(src, {}, function(dirEntry) {
                console.log("Renaming "+src+" to "+newName+"...")
                dirEntry.moveTo(rootDirEntry, newName)
            }, errorHandler)
        })
    }

    async function createDir(rootDirEntry, folder) {
        return new Promise(resolve => {
            rootDirEntry.getDirectory(folder, {create: true}, function(dirEntry){
                console.log("Creating folder "+folder+"...")
            }, errorHandler)
        })
    }

    async function removeDir(rootDirEntry, folder){
        return new Promise(resolve => {
            rootDirEntry.getDirectory(folder, {}, function(dirEntry) {
                dirEntry.removeRecursively(function() {
                    console.log("Directory "+folder+" removed.")
                }, errorHandler)
            }, errorHandler)
        })
    }

    async function createFile(rootDirEntry, filename, filecontent){
        return new Promise(resolve => {
            rootDirEntry.getFile("_transcriptions/"+filename, {create: true, exclusive: true}, function(fileEntry) {
                fileEntry.createWriter(function(fileWriter) {
                    fileWriter.onwriteend = function(e) {
                        console.log('Write completed.')
                    }
                    fileWriter.onerror = function(e) {
                        console.warn('Write failed')
                        console.error(e)
                    }
                    // Create a new Blob and write it to md file
                    var blob = new Blob([filecontent], {type: 'text/markdown'})
                    fileWriter.write(blob)
                }, errorHandler)
            }, errorHandler)
        })
    }

    function errorHandler(e) {
        var msg = e
        console.warn('Error 1: ')
        console.error(msg)
    }

    /*
    * For persistent storage
    window.webkitStorageInfo.requestQuota(PERSISTENT, 2*1024*1024, function(grantedBytes) 
        {
            window.requestFileSystem(PERSISTENT, grantedBytes, onInitFs, errorHandler);
        }, 
        function(e) {
          console.log('Error 2', e);
        }
    )
    */

    function readOutFileSystem(rootDirEntry){
        var dirReader = rootDirEntry.createReader();
        var entries = [];
        console.log("Reading out file system")
        var readEntries = function() {
             dirReader.readEntries(function(results) {
              if (!results.length) {
                console.log(entries.sort())
              } 
              else {
                entries = entries.concat(Array.from(results))
                readEntries()
              }
            }, errorHandler)
        }
        readEntries(); // Start reading dirs.
    }
</script>

</html>
